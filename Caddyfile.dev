# Wikiadviser
{$WIKIADVISER_FRONTEND_ENDPOINT} {
  log {
    output file /var/log/caddy/access-app-prod.log {
      roll_size 10MiB
      roll_keep 10
      roll_keep_for 24h
    }
    }

  #### Mediawiki Prod ####

  handle /wiki/* {

    # Search articles in Wikipedia
    @search_articles {
      query action=query
      query generator=prefixsearch
      path_regexp ^/wiki/([a-z]{2})/api.php
    }
    handle @search_articles {
      rewrite * /w/api.php?lang={re.1}&{query}
      reverse_proxy wiki.adminforge.de:443 {
        header_up Host wiki.adminforge.de
        transport http {
          tls
        }
      }
    }

    @needsAuth not header X-Api-Key {$X_API_KEY}
    forward_auth @needsAuth {$SUPABASE_PROJECT_URL} {
      header_up Host {upstream_hostport}
      header_up X-Real-IP {remote_host}
      uri /functions/v1/restrict-mediawiki-access
      copy_headers X-User X-Client-IP X-Forwarded-Uri
    }
    
    header {
      -X-Frame-Options
      +Content-Security-Policy "frame-ancestors http://localhost:9000";
    }
    rewrite /robots.txt ./robots.txt # Disable search engine indexing

    # Redirect simple article links to Wikipedia
    # simple e.g. /wiki/en/index.php/Main_page
    reverse_proxy {$MEDIAWIKI_INTERNAL_ENDPOINT} {
      handle_response {
        @find_lang_title path_regexp ^/wiki/([a-z]{2})/index.php/([^/?:]+)$
        # Redirect simple articles
        handle @find_lang_title {
          redir https://{re.1}.wikipedia.org/wiki/{re.2} permanent
        }
        # Else, Continue
        copy_response
      }
    }

  }
        
  #### WikiAdviser ####
      
  handle {
    root * /usr/share/caddy/html
    encode gzip
    try_files {path} /index.html
    file_server      
  }
}


