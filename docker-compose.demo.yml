version: "3.1"

services:
  wikiadviser-api:
    image: wikiadviser-api:git
    restart: on-failure
    container_name: wikiadviser-api
    build:
      context: backend
    env_file:
      - .env
    ports:
      - 127.0.0.1:${WIKIADVISER_API_PORT}:${WIKIADVISER_API_PORT}

  wikiadviser-caddy:
    image: wikiadviser-caddy:git
    container_name: wikiadviser-caddy
    volumes:
      - caddy-data:/data
      - ./Caddyfile.demo:/etc/caddy/Caddyfile:ro
      - ./robots.txt:/etc/caddy/robots.txt:ro
      - /var/log/caddy/:/var/log/caddy/
    build:
      context: frontend
      args:
        WIKIADVISER_API_ENDPOINT: ${WIKIADVISER_API_ENDPOINT}
        SUPABASE_PROJECT_URL: ${SUPABASE_PROJECT_URL}
        SUPABASE_SECRET_PROJECT_TOKEN: ${SUPABASE_SECRET_PROJECT_TOKEN}
        MEDIAWIKI_ENDPOINT: ${MEDIAWIKI_ENDPOINT}
        WIKIADVISER_LANGUAGES: ${WIKIADVISER_LANGUAGES}
        MEDIAWIKI_DEV_ENDPOINT: ${MEDIAWIKI_DEV_ENDPOINT}
        MEDIAWIKI_DEMO_ENDPOINT: ${MEDIAWIKI_DEMO_ENDPOINT}
        MEDIAWIKI_PROD_ENDPOINT: ${MEDIAWIKI_PROD_ENDPOINT}
        SHARE_LINK_DAY_LIMIT: ${SHARE_LINK_DAY_LIMIT}
        SENTRY_DSN_FRONTEND: ${SENTRY_DSN_FRONTEND}
        SENTRY_ENV_FRONTEND: ${SENTRY_ENV_FRONTEND}
        

    ports:
      - 443:443
      - 80:80
    environment:
      - WIKIADVISER_API_PORT=${WIKIADVISER_API_PORT}
      - WIKIADVISER_FRONTEND_ENDPOINT=${WIKIADVISER_FRONTEND_ENDPOINT}
      - WIKIADVISER_API_ENDPOINT=${WIKIADVISER_API_ENDPOINT}
      - WIKIADVISER_LANGUAGES=${WIKIADVISER_LANGUAGES}
      - MEDIAWIKI_DEV_ENDPOINT=${MEDIAWIKI_DEV_ENDPOINT}
      - MEDIAWIKI_DEMO_ENDPOINT=${MEDIAWIKI_DEMO_ENDPOINT}
      - MEDIAWIKI_PROD_ENDPOINT=${MEDIAWIKI_PROD_ENDPOINT}
      - SENTRY_DSN_FRONTEND=${SENTRY_DSN_FRONTEND}
      - SENTRY_ENV_FRONTEND=${SENTRY_ENV_FRONTEND}
      - SHARE_LINK_DAY_LIMIT=${SHARE_LINK_DAY_LIMIT}
      - SUPABASE_PROJECT_URL=${SUPABASE_PROJECT_URL}

    depends_on:
      - wikiadviser-api

volumes:
  caddy-data:
